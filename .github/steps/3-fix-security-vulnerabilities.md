<!--
  <<< Author notes: Step 3 >>>
  前のステップを認識してこのステップを始めてください。
  用語を定義し、docs.github.com へのリンクを貼ってください。
  TBD-step-3-notes.
-->

## ステップ 3: セキュリティ脆弱性を修正しよう

_ステップ2「CodeQLアラートの確認とトリアージ」お疲れさまでした :sparkles:_
  
このステップでは、CodeQL によって特定された既存のセキュリティ脆弱性を修正します。ここまでで、CodeQL をリポジトリに導入し、既存コードをスキャンしました。検出された脆弱性は実際の問題なので、修正が必要です！この問題は `/server/routes.py` ファイルを編集して修正します。

### :keyboard: アクティビティ 1: アラートを確認しよう

まず、アラートを修正する前に、アラートがまだオープン状態であることを確認します。また、どのファイルをどのように修正すべきか情報を集めます。

1. コードスキャンアラートページ（**Security** > **Code scanning**）に移動します。
2. "**Open**" と表示されたアラートが2件あるはずです。もし "**Closed**" となっているアラートがあれば、アラートページを開いて **Reopen alert** を選択してください。

両方のアラートがオープンになったら、修正作業に進みます。アラートを見ると、どちらも `server/routes.py` という特定のファイルに問題があることが分かります。問題はデータベース用の SQL クエリの作成方法です。これらのクエリは SQL インジェクション攻撃に対して脆弱です。より安全な SQL 文に書き換えましょう。

アラート下部の **More info** セクションを展開すると、クエリ修正のための明確な提案が記載されています。次のアクティビティでこれを実装します。

### :keyboard: アクティビティ 2: routes.py を編集しよう

問題の場所と修正方法が分かったので、`routes.py` ファイルを修正します。以下の手順は別タブやウィンドウで進めると便利です。

1. リポジトリの **Code** タブをクリックします。
2. `server` フォルダを選択します。
3. `routes.py` ファイルを選択します。
4. 右側の **Edit** ボタンをクリックします。
  
  ![edit-button.png](/images/edit-button.png)
  
5. 16行目の SQL 文を選択し、次の内容に置き換えます: `"SELECT * FROM books WHERE name LIKE %s", name`
  
6. 22行目の SQL 文も次の内容に置き換えます: `"SELECT * FROM books WHERE author LIKE %s", author`
  
7. 右上の **Commit changes...** をクリックします。「Propose changes」ウィンドウが表示されるので、そのまま **Commit changes** をもう一度クリックしてください。
8. CodeQL が新しいスキャンを自動的に開始します。**Actions** に移動し、**CodeQL** アクションを選択してスキャン状況を確認しましょう。スキャンが完了すると、実行の横に緑色のチェックが表示されます。
9. CodeQL スキャンが完了したら、**Security** > **Code scanning** に移動してアラートを確認します。オープンなアラートがゼロ、クローズされたアラートが2件になっているはずです 🎉。クローズされたアラートや監査証跡もぜひ確認してみてください。
10. 約20秒待ってから、このページ（手順を読んでいるページ）をリフレッシュしてください。[GitHub Actions](https://docs.github.com/ja/actions) が自動的に次のステップへ進みます。
